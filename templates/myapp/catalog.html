{% extends 'myapp/base.html' %}

{% block libreria_el_poeta %}{% endblock %}
{% block descripcion %}{% endblock %}

{% block content %}
<div class="my-40 w-full" id="product">
    <h1 class="text-white font-bold text-center text-8xl mt-40" style="font-family: 'Dancing Script'">Catálogo</h1>
    
    <section class="mt-[300px] flex flex-row flex-wrap justify-center sticky">
        {% for producto in productos %}
        <div id="card" class="cursor-pointer card mx-10 bg-white w-[450px] h-auto flex-col border border-black shadow-lg hover:shadow-xl shadow-white mx-26 my-16 rounded-xl pb-2" onclick="showProductDetails('{{ producto.nombre }}', '{{ producto.fotoLink }}', '{{ producto.descripcion }}', '{{ producto.precio_venta }}', '{{ producto.precio_arriendo }}', '{{ producto.editorial }}', '{{ producto.bodega }}', '{{ producto.cantidad_en_stock }}')">
            <h2 class="text-2xl text-center font-bold text-gray-800 mt-3">{{ producto.nombre }}</h2>
            <hr class="border border-gray mr-2 my-2">

            <div class="flex">
                <div class="flex flex-col">
                    <img src="{{ producto.fotoLink }}" class="card-img-top h-60 rounded-xl my-auto mx-2" alt="{{ producto.nombre }}">
                    <h3 class="font-bold mx-2">Autor(es): </h3>
                    {% for autor in producto.autores.all %}
                        <p class="bold mx-2"> {{ autor.nombre }}</p> 
                    {% endfor %}
                    <hr class="border border-gray mr-2 my-2">
                    <p class="font-bold mx-2">Editorial:</p>
                    <p class="mx-2">{{ producto.editorial }}</p>
                </div>
                <div class="card-body">
                    <p class="font-bold">Precio: </p>
                    <p>Venta ${{ producto.precio_venta }}</p>
                    <p>Arriendo ${{ producto.precio_arriendo }}</p>
                    <hr class="border border-gray mr-2 my-2">
                    <p class="font-bold">Bodega: </p>
                    <p>{{ producto.bodega }}</p>
                    <hr class="border border-gray mr-2 my-2">
                    <p class="font-bold">Stock: </p>
                    <p>{{producto.cantidad_en_stock}}</p>
                    <hr class="border border-gray mr-2 my-2">
                    <div class="flex flex-col my-8">
                        <button class="bg-green-500 p-1 rounded shadow shadow-black hover:bg-green-600 hover:shadow-lg" onclick="event.stopPropagation(); openModal('comprar', '{{ producto.nombre }}', {{ producto.precio_venta }})">Añadir Compra</button>
                        <button class="mt-2 bg-blue-500 p-1 rounded shadow shadow-black hover:bg-blue-600 hover:shadow-lg" onclick="event.stopPropagation(); openModal('arrendar', '{{ producto.nombre }}', {{ producto.precio_arriendo }})">Añadir Arriendo</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </section>
</div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-lg w-1/3">
        <h2 class="text-2xl font-bold mb-4" id="modal-title"></h2>
        <p class="mb-6" id="modal-message"></p>
        <div class="flex justify-end space-x-4">
            <button class="bg-red-500 p-2 rounded shadow hover:bg-red-600" onclick="closeModal()">Cancelar</button>
            <button class="bg-green-500 p-2 rounded shadow hover:bg-green-600" onclick="confirmAction()">Confirmar</button>
        </div>
    </div>
</div>

<!-- Modal de descripción del producto -->
<div id="product-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-3xl h-auto max-h-full overflow-auto">
        <h2 class="text-2xl font-bold mb-4" id="product-modal-title"></h2>
        <img id="product-modal-image" src="" alt="Imagen del producto" class="w-64 h-64 mb-4 mx-auto">
        <p id="product-modal-description" class="mb-4"></p>
        <p><strong>Precio Venta:</strong> $<span id="product-modal-price-venta"></span></p>
        <p><strong>Precio Arriendo:</strong> $<span id="product-modal-price-arriendo"></span></p>
        <p><strong>Editorial:</strong> <span id="product-modal-editorial"></span></p>
        <p><strong>Bodega:</strong> <span id="product-modal-bodega"></span></p>
        <p><strong>Stock:</strong> <span id="product-modal-stock"></span></p>
        <div class="flex justify-end space-x-4 mt-4">
            <button class="bg-red-500 p-2 rounded shadow hover:bg-red-600" onclick="closeProductModal()">Cerrar</button>
        </div>
    </div>
</div>

<!-- Mensaje de éxito -->
<div id="success-message" class="fixed bottom-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg hidden">
    Acción realizada con éxito.
</div>

<!-- Carrito de compras -->
<div class="p-4" id="cart">
    <h1 class="text-2xl text-white font-bold mb-4">Carrito de Compras</h1>
    <div id="cart-items" class="bg-white p-4 rounded-lg shadow-lg">
        <p class="text-gray-500">Tu carrito está vacío.</p>
    </div>
    <div id="cart-total" class="bg-white p-4 rounded-lg shadow-lg mt-4">
        <p class="font-bold">Total: $<span id="total-amount">0</span></p>
    </div>
</div>

<script>
let cart = [];
let totalAmount = 0;

function openModal(action, productName, price) {
    console.log("openModal called with action:", action, "and productName:", productName, "and price:", price);
    const modal = document.getElementById('modal');
    const title = document.getElementById('modal-title');
    const message = document.getElementById('modal-message');
    
    modal.dataset.action = action;
    modal.dataset.productName = productName;
    modal.dataset.price = price;
    
    if (action === 'comprar') {
        title.innerText = 'Confirmar Compra';
        message.innerText = `¿Estás seguro de que deseas añadir el producto "${productName}" a tu carrito?`;
    } else if (action === 'arrendar') {
        title.innerText = 'Confirmar Arriendo';
        message.innerText = `¿Estás seguro de que deseas añadir el producto "${productName}" a tu carrito ?`;
    }
    
    modal.classList.remove('hidden');
}

function closeModal() {
    console.log("closeModal called");
    const modal = document.getElementById('modal');
    modal.classList.add('hidden');
}

function confirmAction() {
    console.log("confirmAction called");
    const modal = document.getElementById('modal');
    const action = modal.dataset.action;
    const productName = modal.dataset.productName;
    const price = parseFloat(modal.dataset.price);

    console.log("Action:", action, "Product Name:", productName, "Price:", price);

    // Actualizar el carrito
    const cart = document.getElementById('cart-items');
    if (cart) {
        console.log("Updating cart with action:", action, "and product:", productName, "price:", price);
        const cartItem = document.createElement('div');
        cartItem.className = 'p-2 border-b';
        cartItem.innerText = `${action.charAt(0).toUpperCase() + action.slice(1)}: ${productName} - $${price}`;
        cart.appendChild(cartItem);

        // Remove "Tu carrito está vacío." if it exists
        const emptyMessage = cart.querySelector('.text-gray-500');
        if (emptyMessage) {
            emptyMessage.remove();
        }

        // Actualizar el total
        totalAmount += price;
        document.getElementById('total-amount').innerText = totalAmount.toFixed(2);
    } else {
        console.error("Cart element not found");
    }
    
    // Mostrar mensaje de éxito
    const successMessage = document.getElementById('success-message');
    if (successMessage) {
        successMessage.classList.remove('hidden');
        setTimeout(() => {
            successMessage.classList.add('hidden');
        }, 3000);
    } else {
        console.error("Success message element not found");
    }
    
    closeModal();
}

function showProductDetails(name, image, description, priceVenta, priceArriendo, editorial, bodega, stock) {
    const productModal = document.getElementById('product-modal');
    document.getElementById('product-modal-title').innerText = name;
    document.getElementById('product-modal-image').src = image;
    document.getElementById('product-modal-description').innerText = description;
    document.getElementById('product-modal-price-venta').innerText = priceVenta;
    document.getElementById('product-modal-price-arriendo').innerText = priceArriendo;
    document.getElementById('product-modal-editorial').innerText = editorial;
    document.getElementById('product-modal-bodega').innerText = bodega;
    document.getElementById('product-modal-stock').innerText = stock;
    
    productModal.classList.remove('hidden');
}

function closeProductModal() {
    const productModal = document.getElementById('product-modal');
    productModal.classList.add('hidden');
}
</script>
{% endblock %}
